# exchange contract

## Foreword
This is a decentralized exchange contract based on chain33. It does not charge any fees. It is used to meet the exchange of virtual assets between a small group of people or other specific business scenarios.

## use
The contract provides a sound query interface similar to that of a centralized exchange, and all interface designs are based on the userâ€™s perspective
The contract interface, online construction transaction and query interface reuse the CreateTransaction and Query interfaces in the framework respectively. For details, please refer to
[CreateTransaction interface](https://github.com/33cn/chain33/blob/master/rpc/jrpchandler.go#L1101) and [Query interface](https://github.com/33cn/chain33/blob/master /rpc/jrpchandler.go#L838)

Query method name|function
-----|----
QueryMarketDepth|Get the market depth of the specified trading asset
QueryHistoryOrderList|Get real-time information about orders that have been executed for a specified trading pair
QueryOrder|Query specific order information according to orderID order number
QueryOrderList|According to user address and order status (ordered, completed, revoked), obtain corresponding order details in real time

You can refer to the related test cases in exchange_test.go to construct limitOrder or revokeOrder transactions for related tests

## Precautions
The contract matching rules are as follows:

Serial number|rules
---|----
1|The principle of buyer's profit
2|Buying orders are higher than the market price, and the price is matched from low to high
3|The sell order is lower than the market price, and the price is matched from high to low
4|The same price is matched according to the principle of first-in first-out
5|For the sake of system security, the maximum matching depth is 100 orders, and the minimum single pending order is 1e8, which is a bty

**Table structure description**

Table name|Primary key|Index|Purpose|Description
 ---|---|---|---|---
 depth|price|nil|Dynamic record of market depth|The primary key price is a composite primary key composed of {leftAsset}:{rightAsset}:{op}:{price}
 order|orderID|market_order,addr_status|Real-time dynamic maintenance and updating of pending orders on the market|market_order is a composite index by {leftAsset}:{rightAsset}:{op}:{price}:{orderID}, addr_status is a composite index by {addr} :{status}, when the order is filled or withdrawn, the order record and index will be automatically deleted from the order table
 history|index|name,addr_status|Real-time record of the latest completed order information under an asset transaction pair (transactions in the revoked state will also be recorded)|name is a composite index composed of {leftAsset}:{rightAsset}, addr_status is a composite index consisting of { addr}:{status}

**Description of relevant parameters in the table**

Parameter name|Description
----|----
leftAsset|The name of the asset on the left of the trading pair
rightAsset|The name of the asset on the right of the trading pair
op|Buying operation 1 is buying, 2 is selling
status|Pending order status, 0 ordered, 1 completed, 2 revoked
price|Pending order price, occupies 16% 016d. In order to be compatible with systems of different architectures, it is designed as an integer here, which is multiplied by 1e8 by the original floating-point type. For example, a trading pair is 0.25 on a centralized exchange, here it becomes 25000000, and the price range is an integer of 1<=price<=1e16
orderID|Order ID, automatically generated by the system, integer, occupying 22% 022d
index|index automatically generated by the system, occupying 22% 022d